name: Update Rolling Draft Release

on:
  push:
    branches:
      - main

jobs:
  validate_gradle_wrapper:
    name: Validate Gradle Wrapper
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

  build_and_release:
    name: Build and Update Draft Release
    needs: validate_gradle_wrapper
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle and Enable Caching
        uses: gradle/actions/setup-gradle@v3

      - name: Write google-services.json
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: app/google-services.json
          contents: ${{ secrets.GOOGLE_SERVICE_JSON }}

      - name: Install Android Build Tools
        run: echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;29.0.3"

      - name: Build App
        run: ./gradlew assembleStandardRelease

      - name: Sign APKs
        id: sign_app
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/standard/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Prepare Release Artifacts and Checksums
        id: prep_artifacts
        run: |
          ARTIFACT_DIR="${{ steps.sign_app.outputs.signedReleaseFileDirectory }}"
          mv "$ARTIFACT_DIR"/*universal-release-unsigned-signed.apk neko-universal.apk
          mv "$ARTIFACT_DIR"/*arm64-v8a-release-unsigned-signed.apk neko-arm64-v8a.apk
          mv "$ARTIFACT_DIR"/*armeabi-v7a-release-unsigned-signed.apk neko-armeabi-v7a.apk
          mv "$ARTIFACT_DIR"/*x86-release-unsigned-signed.apk neko-x86.apk
          mv "$ARTIFACT_DIR"/*x86_64-release-unsigned-signed.apk neko-x86_64.apk
          echo "SHA_TABLE<<EOF" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### Downloads & Checksums" >> $GITHUB_ENV
          echo "| Variant     | SHA-256 Checksum |" >> $GITHUB_ENV
          echo "|:------------|:-----------------|" >> $GITHUB_ENV
          for apk in *.apk; do
            variant=$(echo "$apk" | sed -e 's/neko-//' -e 's/.apk//')
            checksum=$(sha256sum "$apk" | awk '{ print $1 }')
            echo "| \`$variant\` | \`$checksum\` |" >> $GITHUB_ENV
          done
          echo "EOF" >> $GITHUB_ENV

      - name: Update GitHub Draft Release
        uses: ncipollo/release-action@v1
        with:
          tag: lates
          generateReleaseNotes: true
          body: ${{ env.SHA_TABLE }}
          draft: true
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "*.apk"
